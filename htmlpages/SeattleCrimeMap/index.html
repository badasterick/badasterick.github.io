<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Seattle Crime Map (Working Version)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .panel {
    position:absolute; top:10px; left:10px; z-index:1000;
    background:rgba(255,255,255,0.96);
    padding:12px; border-radius:14px;
    box-shadow:0 2px 14px rgba(0,0,0,0.15);
    max-width:380px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .row { display:flex; flex-wrap:wrap; align-items:center; gap:6px; margin:5px 0; }
  .pill { border:1px solid #ccc; border-radius:999px; padding:5px 10px; }
  button { border:1px solid #ccc; border-radius:999px; background:white; cursor:pointer; padding:5px 10px; }
  button.active { background:#0b57d0; color:white; }
  .badge { background:#f4f4f4; border-radius:999px; padding:3px 8px; font-size:12px; }
</style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <div style="font-weight:700; font-size:16px; margin-bottom:6px;">Seattle Crime Map</div>
  <div class="row">
    <label>Days:</label><input id="days" type="number" class="pill" min="1" max="3650" value="180"/>
    <label>Filter:</label><input id="filter" class="pill" placeholder="e.g. BURGLARY or ASSAULT"/>
    <button id="refresh">Refresh</button><span id="count" class="badge">0 pts</span>
  </div>
  <div class="row">
    <label><input type="checkbox" id="heat" checked/> Heatmap</label>
    <label><input type="checkbox" id="cluster" checked/> Clusters</label>
  </div>
  <div style="font-size:12px; margin-top:8px;">
    Filter by offense type or neighborhood (MCPP). The map loads up to 10,000 of the most recent incidents within the selected time window.
  </div>
</div>

<script>
(async function(){
  const map = L.map('map').setView([47.6062, -122.3321], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 17 });
  const heat = L.heatLayer([], { radius: 20, blur: 15, maxZoom: 17 });
  map.addLayer(cluster); map.addLayer(heat);

  const daysEl = document.getElementById('days');
  const filterEl = document.getElementById('filter');
  const refresh = document.getElementById('refresh');
  const countEl = document.getElementById('count');
  const chkHeat = document.getElementById('heat');
  const chkCluster = document.getElementById('cluster');

  chkHeat.addEventListener('change',()=>{ chkHeat.checked ? map.addLayer(heat):map.removeLayer(heat); });
  chkCluster.addEventListener('change',()=>{ chkCluster.checked ? map.addLayer(cluster):map.removeLayer(cluster); });

  function dateNDaysAgo(n){
    const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()-n);
    return d.toISOString().split('T')[0]; // only date
  }

  async function fetchSeattle(days,filter){
    const from=dateNDaysAgo(days);
    const safeFilter = (filter||'').replace(/'/g,"''");
    let query = `
      SELECT offense_parent_group, offense, mcpp, report_date, hundred_block_location, latitude, longitude
      WHERE report_date >= '${from}'
      AND latitude IS NOT NULL AND longitude IS NOT NULL
    `;
    if(safeFilter){
      const f = safeFilter.toUpperCase();
      query += ` AND (upper(offense) LIKE '%${f}%' OR upper(offense_parent_group) LIKE '%${f}%' OR upper(mcpp) LIKE '%${f}%')`;
    }
    query += ` ORDER BY report_date DESC LIMIT 10000`;

    const url = 'https://data.seattle.gov/resource/tazs-3rd5.geojson?$query=' + encodeURIComponent(query);
    const r = await fetch(url);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }

  async function load(){
    const days = Math.max(1, Math.min(3650, parseInt(daysEl.value||'180',10)));
    const text = filterEl.value || '';
    countEl.textContent='â€¦';
    cluster.clearLayers(); heat.setLatLngs([]);
    try{
      const data = await fetchSeattle(days, text);
      const heats=[]; let c=0;
      L.geoJSON(data, {
        pointToLayer:(f,latlng)=>{
          const p=f.properties||{};
          const title=p.offense||p.offense_parent_group||'Incident';
          const when=p.report_date||'';
          const mcpp=p.mcpp||'';
          const addr=p.hundred_block_location||'';
          const marker=L.marker(latlng).bindPopup(`<b>${title}</b><br>${mcpp}<br>${addr}<br>${when}`);
          heats.push([latlng.lat,latlng.lng,0.4]);
          c++; return marker;
        }
      }).eachLayer(l=>cluster.addLayer(l));
      heat.setLatLngs(heats);
      countEl.textContent=c.toLocaleString()+' pts';
    }catch(e){
      console.error('Seattle fetch failed:',e);
      countEl.textContent='error';
      alert('Could not fetch data: '+e.message);
    }
  }

  refresh.addEventListener('click',load);
  load();
})();
</script>
</body>
</html>
